<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>دوز آنلاین دونفره | ساخت اتاق و لینک دعوت</title>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0e141b; --panel:#111a23; --muted:#96a5b5; --text:#e8eef5; --brand:#4ad395; --danger:#ff6b6b; --accent:#69b7ff;
      --grid:#1b2837; --win:#1f7a43; --draw:#5f6d7a; --warn:#f7b500;
    }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 600px at 20% -10%, #132030, #0b1219 60%), var(--bg);color:var(--text);font-family:Vazirmatn,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:980px;margin:auto;padding:24px}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:18px}
    h1{font-size:22px;margin:0;font-weight:800;letter-spacing:-.2px}
    .badge{font-size:12px;color:#0b1219;background:var(--brand);padding:6px 10px;border-radius:999px;white-space:nowrap}

    .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.06);border-radius:18px;padding:16px}
    .grid{display:grid;grid-template-columns:repeat(3,110px);grid-gap:8px;justify-content:center;margin:10px auto}
    .cell{width:110px;height:110px;border-radius:16px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:46px;cursor:pointer;background:#0f1721;border:1px solid var(--grid);transition:.15s transform}
    .cell:hover{transform:translateY(-1px)}
    .cell.disabled{opacity:.45;pointer-events:none}
    .cell.x{color:#69b7ff}
    .cell.o{color:#ffd166}
    .status{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:center;margin:10px 0}

    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .row > *{flex:0 0 auto}
    .grow{flex:1 1 160px}

    input,button{height:44px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:#0f1620;color:var(--text);padding:0 12px;font-family:inherit}
    input::placeholder{color:#6f8196}
    button{cursor:pointer;font-weight:700}
    .btn{background:linear-gradient(180deg, rgba(74,211,149,.12), rgba(74,211,149,.06));border-color:rgba(74,211,149,.35)}
    .btn.secondary{background:linear-gradient(180deg, rgba(105,183,255,.12), rgba(105,183,255,.06));border-color:rgba(105,183,255,.35)}
    .btn.warn{background:linear-gradient(180deg, rgba(247,181,0,.14), rgba(247,181,0,.07));border-color:rgba(247,181,0,.45)}
    .btn.danger{background:linear-gradient(180deg, rgba(255,107,107,.14), rgba(255,107,107,.07));border-color:rgba(255,107,107,.45)}

    .mini{height:36px;padding:0 10px;font-weight:700}
    .pill{border-radius:999px}

    .players{display:flex;gap:10px;align-items:center;justify-content:center;margin:8px 0}
    .player{display:flex;gap:6px;align-items:center;background:#0f1620;border:1px solid rgba(255,255,255,.06);padding:6px 10px;border-radius:999px}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.x{background:#69b7ff}
    .dot.o{background:#ffd166}

    .linkbox{display:flex;gap:8px;align-items:center}
    .linkbox input{width:100%}

    .banner{padding:10px 12px;border-radius:12px;background:#0f1620;border:1px solid rgba(255,255,255,.08);color:var(--muted);font-size:14px}
    .banner.win{background:linear-gradient(180deg,rgba(31,122,67,.22),rgba(31,122,67,.1));color:#c0ffd9;border-color:rgba(31,122,67,.5)}
    .banner.draw{background:linear-gradient(180deg,rgba(95,109,122,.2),rgba(95,109,122,.1));color:#e2e7ee;border-color:rgba(95,109,122,.4)}

    footer{margin-top:20px;color:var(--muted);font-size:13px;text-align:center}
    .hidden{display:none !important}

    @media (max-width:480px){
      .grid{grid-template-columns:repeat(3,94px)}
      .cell{width:94px;height:94px;font-size:38px}
    }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>دوز آنلاین دونفره</h1>
    <span class="badge">ساخت اتاق + لینک دعوت</span>
  </header>

  <section class="card" id="lobby">
    <div class="row" style="margin-bottom:12px">
      <input id="nameInput" class="grow" placeholder="نام شما" />
      <button id="saveNameBtn" class="btn pill">ذخیره نام</button>
    </div>
    <div class="row" style="margin-bottom:10px">
      <button id="createBtn" class="btn">ساخت اتاق جدید</button>
      <input id="joinCode" placeholder="کد اتاق" style="width:140px" />
      <button id="joinBtn" class="btn secondary">پیوستن</button>
    </div>
    <div class="banner">راهنما: «ساخت اتاق» را بزن، لینک دعوت را برای نفر دوم بفرست. یا اگر لینکی گرفتی، فقط بازش کن تا مستقیم وارد اتاق شوی.</div>
  </section>

  <section id="room" class="card hidden">
    <div class="row" style="justify-content:space-between;margin-bottom:10px">
      <div class="row" style="gap:8px">
        <div class="player"><span class="dot x"></span><b>X</b><span id="pX">—</span></div>
        <div class="player"><span class="dot o"></span><b>O</b><span id="pO">—</span></div>
      </div>
      <div class="row" style="gap:8px">
        <button id="leaveBtn" class="btn danger mini pill">خروج از اتاق</button>
      </div>
    </div>

    <div class="row" style="gap:8px;margin-bottom:10px">
      <div class="grow linkbox">
        <input id="inviteLink" readonly>
        <button id="copyBtn" class="btn mini pill">کپی لینک دعوت</button>
      </div>
      <div class="row">
        <span class="banner" id="codeBadge">کد: —</span>
      </div>
    </div>

    <div class="status" id="statusArea"></div>

    <div class="grid" id="board"></div>

    <div class="row" style="justify-content:center;margin-top:8px;gap:8px">
      <button id="newGameBtn" class="btn warn pill mini">بازی جدید</button>
    </div>
  </section>

  <footer>
    <div>فایل تک‌صفحه‌ای | میزبانی راحت روی GitHub Pages</div>
  </footer>
</div>

<!-- ✅ Firebase SDK (Compat for simplicity in a single file) -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<script>
/**
 * راه‌اندازی سریع
 * 1) در Firebase یک پروژه بسازید و Realtime Database را روی حالت "Start in test mode" ایجاد کنید.
 * 2) پیکربندی زیر را با مقادیر پروژه خود جایگزین کنید.
 * 3) همین فایل index.html را روی هر هاستی مثل GitHub Pages آپلود کنید.
 */
const firebaseConfig = {
  apiKey: "PASTE_API_KEY",
  authDomain: "PASTE_AUTH_DOMAIN",
  databaseURL: "PASTE_DB_URL",
  projectId: "PASTE_PROJECT_ID",
  storageBucket: "PASTE_BUCKET",
  messagingSenderId: "PASTE_SENDER",
  appId: "PASTE_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ===== Helpers =====
const qs = s => document.querySelector(s);
const boardEl = qs('#board');
const statusArea = qs('#statusArea');
const nameInput = qs('#nameInput');
const saveNameBtn = qs('#saveNameBtn');
const createBtn = qs('#createBtn');
const joinBtn = qs('#joinBtn');
const joinCode = qs('#joinCode');
const lobby = qs('#lobby');
const roomSection = qs('#room');
const pX = qs('#pX');
const pO = qs('#pO');
const codeBadge = qs('#codeBadge');
const inviteLink = qs('#inviteLink');
const copyBtn = qs('#copyBtn');
const leaveBtn = qs('#leaveBtn');
const newGameBtn = qs('#newGameBtn');

const uid = localStorage.getItem('ttt_uid') || (()=>{const id = crypto.randomUUID(); localStorage.setItem('ttt_uid', id); return id;})();
nameInput.value = localStorage.getItem('ttt_name') || '';
saveNameBtn.onclick = () => { localStorage.setItem('ttt_name', nameInput.value.trim()); toast('نام ذخیره شد.'); }

let roomId = null;
let myMark = null; // 'X' | 'O' | null (تماشاچی)
let unsub = null; // unsubscribe listener

function randomCode(len=6){
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let out='';
  for(let i=0;i<len;i++) out+=chars[Math.floor(Math.random()*chars.length)];
  return out;
}
function roomRef(id){ return db.ref('rooms/'+id); }
function now(){ return Date.now(); }
function toast(msg){
  statusArea.innerHTML = `<div class="banner">${msg}</div>`;
}

function setUI(inRoom){
  lobby.classList.toggle('hidden', !!inRoom);
  roomSection.classList.toggle('hidden', !inRoom);
}

function currentOrigin(){
  const {protocol,host,pathname} = location;
  return protocol+"//"+host+pathname.replace(/[^\/]*$/, '');
}

async function createRoom(){
  const name = (nameInput.value || 'بازیکن').trim();
  localStorage.setItem('ttt_name', name);
  const id = randomCode();
  const ref = roomRef(id);
  await ref.set({
    createdAt: now(),
    players: { X: null, O: null },
    state: {
      board: '---------', // 9 chars
      turn: 'X',
      status: 'waiting', // waiting | playing | finished
      winner: null,
      lastMoveAt: now()
    }
  });
  joinRoom(id, name, true);
}

async function joinRoom(id, name, asCreator=false){
  roomId = id;
  setUI(true);
  codeBadge.textContent = 'کد: '+id;
  inviteLink.value = location.origin + location.pathname + '?room=' + id;

  const ref = roomRef(id);
  // Claim seat transaction
  await ref.child('players').transaction(players => {
    if(!players) return players;
    if(players.X?.id === uid || players.O?.id === uid) return players; // already set
    const n = name || (localStorage.getItem('ttt_name')||'بازیکن');
    if(players.X === null){
      players.X = { id: uid, name: n };
      myMark = 'X';
    } else if(players.O === null){
      players.O = { id: uid, name: n };
      myMark = 'O';
    } else {
      myMark = null; // spectator
    }
    return players;
  });

  // If two players, set status to playing
  await ref.once('value').then(s => {
    const val = s.val();
    if(val){
      if(val.players?.X && val.players?.O && val.state?.status === 'waiting'){
        ref.child('state/status').set('playing');
      }
    }
  });

  // Presence cleanup
  const role = myMark;
  if(role){
    ref.child('players/'+role).onDisconnect().set(null);
    ref.child('state/status').onDisconnect().set('waiting');
  }

  // Subscribe
  if(unsub) { ref.off('value', unsub); }
  unsub = snap => renderRoom(snap.val());
  ref.on('value', unsub);
}

function renderRoom(data){
  if(!data){ toast('این اتاق یافت نشد یا حذف شده است.'); return; }
  pX.textContent = data.players?.X?.name || '—';
  pO.textContent = data.players?.O?.name || '—';

  // Build board UI
  boardEl.innerHTML = '';
  const b = (data.state?.board || '---------').split('');
  b.forEach((v,i)=>{
    const btn = document.createElement('button');
    btn.className = 'cell' + (v==='X'?' x':'') + (v==='O'?' o':'');
    btn.textContent = (v==='-'?'':v);
    const canPlay = canIMove(data, i);
    if(!canPlay) btn.classList.add('disabled');
    btn.onclick = () => makeMove(i);
    boardEl.appendChild(btn);
  });

  // Status banner
  const st = data.state?.status;
  const turn = data.state?.turn;
  const winner = data.state?.winner;
  statusArea.innerHTML='';
  const div = document.createElement('div');
  div.className = 'banner';
  if(st==='waiting'){
    div.innerHTML = 'منتظر بازیکن دوم… لینک دعوت را بفرست!';
  } else if(st==='playing'){
    const mine = roleText(myMark);
    const t = turn==='X'? 'نوبت X' : 'نوبت O';
    div.innerHTML = `${t} ${myMark?`— ${mine}`:''}`;
  } else if(st==='finished'){
    div.classList.add(winner? 'win':'draw');
    div.innerHTML = winner? `برنده: <b>${winner}</b>` : 'مساوی شد!';
  }
  statusArea.appendChild(div);

  // Enable/disable New Game
  const both = !!(data.players?.X && data.players?.O);
  newGameBtn.disabled = !both;
}

function roleText(mark){
  if(!mark) return '(تماشاچی)';
  return mark==='X'? '(شما X هستید)': '(شما O هستید)';
}

function canIMove(data, idx){
  if(!myMark) return false;
  if(data.state?.status !== 'playing') return false;
  if(data.state?.turn !== myMark) return false;
  const cell = (data.state.board||'---------')[idx];
  return cell === '-';
}

function winnerOf(board){
  const b = board.split('');
  const W = [ [0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6] ];
  for(const [a,c,e] of W){
    if(b[a]!=='-' && b[a]===b[c] && b[a]===b[e]) return b[a];
  }
  return null;
}

async function makeMove(i){
  if(!roomId) return;
  const ref = roomRef(roomId).child('state');
  await ref.transaction(st => {
    if(!st) return st;
    if(st.status!=='playing') return st;
    if(st.turn!==myMark) return st;
    const b = st.board.split('');
    if(b[i] !== '-') return st;
    b[i] = myMark;
    st.board = b.join('');
    // Check winner / draw
    const w = winnerOf(st.board);
    if(w){ st.status='finished'; st.winner=w; }
    else if(!st.board.includes('-')){ st.status='finished'; st.winner=null; }
    else { st.turn = (st.turn==='X'?'O':'X'); }
    st.lastMoveAt = now();
    return st;
  });
}

async function newGame(){
  if(!roomId) return;
  const ref = roomRef(roomId);
  const snap = await ref.once('value');
  const val = snap.val();
  if(!(val?.players?.X && val?.players?.O)) { toast('برای شروع بازی جدید، هر دو بازیکن باید حاضر باشند.'); return; }
  await ref.child('state').set({
    board:'---------', turn:'X', status:'playing', winner:null, lastMoveAt: now()
  });
}

async function leaveRoom(){
  if(!roomId) return;
  const ref = roomRef(roomId);
  const role = myMark;
  if(role){ await ref.child('players/'+role).set(null); }
  myMark = null; roomId = null;
  setUI(false);
}

// ===== Events =====
createBtn.onclick = () => createRoom();
joinBtn.onclick = () => {
  const id = (joinCode.value||'').trim().toUpperCase();
  if(!id) return toast('کد اتاق را وارد کنید.');
  const name = (nameInput.value || 'بازیکن').trim();
  joinRoom(id, name);
}
copyBtn.onclick = async () => {
  try{ await navigator.clipboard.writeText(inviteLink.value); toast('لینک دعوت کپی شد.'); }catch{ toast('مرورگر اجازهٔ کپی نداد. دستی کپی کنید.'); }
}
leaveBtn.onclick = () => leaveRoom();
newGameBtn.onclick = () => newGame();

// ===== Deep link ( ?room=CODE ) =====
(function initFromURL(){
  const p = new URLSearchParams(location.search);
  const r = (p.get('room')||'').toUpperCase();
  if(r){
    const name = (localStorage.getItem('ttt_name') || 'مهمان').trim();
    joinRoom(r, name);
  }
})();
</script>
</body>
</html>
